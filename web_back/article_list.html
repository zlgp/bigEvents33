<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>文章列表</title>
    <link rel="stylesheet" href="js/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/iconfont.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/jquery-1.12.4.min.js"></script>
    <!-- 导入分页插件 -->
    <script src="./js/jquery.twbsPagination.min.js"></script>
</head>

<body>
    <div class="container-fluid">
        <div class="common_title">
            文章列表
        </div>
        <div class="container-fluid common_con">
            <div class="row opt_btns">
                <div class="col-xs-6">
                    <form class="form-inline">
                        <select id="selCategory" name="" class="form-control input-sm">
                            <option value="">所有分类</option>

                        </select>
                        <select id="selStatus" name="" class="form-control input-sm">
                            <option value="">所有状态</option>
                            <option value="草稿">草稿</option>
                            <option value="已发布">已发布</option>
                        </select>
                        <button id="btnSearch" class="btn btn-default btn-sm">筛选</button>
                    </form>
                </div>
                <div class="col-xs-6">
                    <a href="article_release.html" class="btn btn-success btn-sm pull-right" id="release_btn">发表文章</a>
                </div>
            </div>

            <table class="table table-striped table-bordered table-hover mp20">
                <thead>
                    <tr>
                        <th>标题</th>
                        <th>作者</th>
                        <th>分类</th>
                        <th class="text-center">发表时间</th>
                        <th class="text-center">状态</th>
                        <th class="text-center" width="100">操作</th>
                    </tr>
                </thead>
                <tbody>



                    <tr>

                        <td>王积千造统最头</td>
                        <td>杰克</td>
                        <td>奇趣事</td>
                        <td class="text-center">2017-06-08 07:08:46</td>


                        <td class="text-center">已发布</td>


                        <td class="text-center">
                            <a href="article_edit.html" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 1005 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>



                    <tr>

                        <td>级电使正回</td>
                        <td>肉丝</td>
                        <td>爱旅行</td>
                        <td class="text-center">2017-06-06 10:45:24</td>


                        <td class="text-center">已发布</td>


                        <td class="text-center">
                            <a href="article_edit.html" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 1004 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>



                    <tr>

                        <td>近难领管年算</td>
                        <td>杰克</td>
                        <td>会生活</td>
                        <td class="text-center">2017-05-27 16:49:04</td>


                        <td class="text-center">已发布</td>


                        <td class="text-center">
                            <a href="article_edit.html" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 1003 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>



                    <tr>

                        <td>龙大实究</td>
                        <td>杰克</td>
                        <td>未分类</td>
                        <td class="text-center">2017-04-13 10:43:41</td>


                        <td class="text-center">草稿</td>


                        <td class="text-center">
                            <a href="post-edit.html?id=1002" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 1002 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>



                    <tr>

                        <td>算性得走来拉</td>
                        <td>肉丝</td>
                        <td>奇趣事</td>
                        <td class="text-center">2017-04-06 04:58:12</td>


                        <td class="text-center">已发布</td>


                        <td class="text-center">
                            <a href="post-edit.html?id=1001" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 1001 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>



                    <tr>

                        <td>几平会出气</td>
                        <td>管理员</td>
                        <td>奇趣事</td>
                        <td class="text-center">2017-04-03 20:16:34</td>


                        <td class="text-center">草稿</td>


                        <td class="text-center">
                            <a href="post-edit.html?id=1000" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 1000 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>



                    <tr>

                        <td>世团先证型角</td>
                        <td>杰克</td>
                        <td>奇趣事</td>
                        <td class="text-center">2017-04-03 14:40:08</td>


                        <td class="text-center">已发布</td>


                        <td class="text-center">
                            <a href="post-edit.html?id=999" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 999 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>



                    <tr>

                        <td>构更反步五</td>
                        <td>肉丝</td>
                        <td>奇趣事</td>
                        <td class="text-center">2017-03-30 22:31:52</td>


                        <td class="text-center">已发布</td>


                        <td class="text-center">
                            <a href="post-edit.html?id=998" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 998 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>



                    <tr>

                        <td>组方些</td>
                        <td>肉丝</td>
                        <td>会生活</td>
                        <td class="text-center">2017-02-08 05:38:43</td>


                        <td class="text-center">草稿</td>


                        <td class="text-center">
                            <a href="post-edit.html?id=996" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 996 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>



                    <tr>

                        <td>日做发光成</td>
                        <td>管理员</td>
                        <td>爱旅行</td>
                        <td class="text-center">2017-01-26 22:19:59</td>


                        <td class="text-center">草稿</td>


                        <td class="text-center">
                            <a href="post-edit.html?id=995" class="btn btn-default btn-xs">编辑</a>
                            <a href="javascript:deleteTr( 995 );" class="btn btn-danger btn-xs">删除</a>
                        </td>
                    </tr>


                </tbody>
            </table>

            <div class="row text-center">
                <ul class="pagination pagination-sm">
                    <li class="page-item first disabled"><a href="#" class="page-link">首页</a></li>
                    <li class="page-item prev disabled"><a href="#" class="page-link">上一页</a></li>
                    <li class="page-item active"><a href="#" class="page-link">1</a></li>
                    <li class="page-item"><a href="#" class="page-link">2</a></li>
                    <li class="page-item"><a href="#" class="page-link">3</a></li>
                    <li class="page-item"><a href="#" class="page-link">4</a></li>
                    <li class="page-item"><a href="#" class="page-link">5</a></li>
                    <li class="page-item"><a href="#" class="page-link">6</a></li>
                    <li class="page-item"><a href="#" class="page-link">7</a></li>
                    <li class="page-item next"><a href="#" class="page-link">下一页</a></li>
                    <li class="page-item last"><a href="#" class="page-link">尾页</a></li>
                </ul>
            </div>

        </div>
    </div>
    <!-- 导入模板引擎文件 -->
    <script src="./js/template-web.js"></script>
    <!-- 定义模板 -->
    <script id="tem" type="text/html">
  {{each data}}
  <tr>
        <td>{{$value.title}}</td>
        <td>{{$value.author}}</td>
        <td>{{$value.type}}</td>
        <td class="text-center">{{$value.date}}</td>
        <td class="text-center">{{$value.state}}</td>
        <td class="text-center">
            <a href="article_edit.html" class="btn btn-default btn-xs">编辑</a>
            <a href="javascript:deleteTr( 1005 );" class="btn btn-danger btn-xs">删除</a>
        </td>
    </tr>
    {{/each}}
</script>
    <script id="tem1" type="text/html">
    {{each data}}
    <option value="{{$value.id}}">{{$value.name}}</option>
    {{/each}}
</script>
    <script>
        // 设置左侧菜单
        $('#release_btn').click(function () {
            window.parent.setMenu(1, 1);
        })
    </script>
    <script>
        // 文章列表(article_list.html)
        // 文章获取
        // 请求地址：http://localhost:8000/admin/search
        // 请求方式：get
        // 请求参数：
        // 名称   	  类型  	说明
        // key  	string	搜索关键词，可以为空，为空返回某类型所有文章
        // type string	文章类型，可以为空，为空返回所有类型文章
        // state 	string	文章状态，草稿或者已发布
        // page  	number	当前页，为空返回第1页
        // perpage	number	每页显示条数，为空默认每页6条
        // 步骤
        // 1. 进入文章页面之后
        // 2. 通过ajax获取数据 数据获取到之后
        // 3. 默认不考虑筛选，先选择页码和每页的数据条数即可
        // 4. 渲染到页面上

        // $(function () {
        //     var myPage = 1

        //     function getData() {
        //         $.ajax({
        //             url: "http://localhost:8000/admin/search",
        //             type: "get",
        //             data: {
        //                 page: myPage,
        //                 perpage: 10,
        //                 // 动态获取下拉框的值,以保证每次获取都是最新的值
        //                 state:$("#selStatus").val(),
        //             },
        //             success: function (dataBack) {
        //                 console.log(dataBack);
        //                 // 调用核心方法
        //                 var html = template("tem", dataBack);
        //                 $("tbody").html(html);

        //             }
        //         })
        //     }
        //     //  默认调用一次
        //     getData()

        //     // 分页
        //     var $pagination = $('.pagination')
        //     // 默认设置
        //     var defaultOpts = {
        //         totalPages: 20,
        //         //   改按钮的内容
        //         first: '第一页',
        //         prev: '上一页',
        //         next: '下一页',
        //         last: '尾页',
        //         onPageClick: function (event, page) {
        //             // console.log(event);
        //             // console.log(page);
        //             // 修改page的值
        //             myPage = page
        //             // 重新获取数据
        //             getData()
        //         }
        //     }
        //     // 把设置传递给分页方法 并生效
        //     $pagination.twbsPagination(defaultOpts);
        //     // 给筛选按钮加点击事件
        //     $("#btnSearch").click(function(e){
        //         e.preventDefault();
        //         getData();
        //     })
        // })
        $(function () {
            /*      文章列表(article_list.html)
             文章获取
             请求地址：http://localhost:8000/admin/search
             请求方式：get
             请求参数：
                 名称   	  类型  	说明                    
                 key  	string	搜索关键词，可以为空，为空返回某类型所有文章
                type  	string	文章类型，可以为空，为空返回所有类型文章  
                state 	string	文章状态，草稿或者已发布          
                page  	number	当前页，为空返回第1页           
               perpage	number	每页显示条数，为空默认每页6条       
             步骤
             1. 进入文章页面之后
             2. 通过ajax获取数据 数据获取到之后 
             3. 默认不考虑筛选，先选择页码和每页的数据条数即可
             4. 渲染到页面上  */
            var myPage = 1;
            // 分页,用插件做
            var $pagination = $('.pagination ');
            // 总页数单独定义
            var myTotalPages = 20;
            var defaultOpts = {
                totalPages: myTotalPages,
                first: "第一页",
                prev: "上一页",
                next: "下一页",
                last: "最后一页",
                onPageClick: function (event, page) {
                    // 修改页面的值
                    myPage = page;
                    // 局部刷新
                    getData()
                }
            };

            // 把设置传递给分页方法 并生效
            $pagination.twbsPagination(defaultOpts);
            function getData() {
                $.ajax({
                    url: 'http://localhost:8000/admin/search',
                    type: 'get',
                    data: {
                        page: myPage,
                        perpage: 8,
                        // 动态获得下拉框的值
                        state: $("#selStatus").val(),
                        type: $("#selCategory").val(),
                    },
                    success: function (dataBack) {
                        console.log(dataBack);
                        var html = template('tem', dataBack);
                        $('tbody').html(html);
                        // // 重新设置页码 如果当前总页数 和服务器返回的新总页数不相等 才重新设置
                        if (myTotalPages != dataBack.totalPage) {
                            // 保存新总页数
                            myTotalPages = dataBack.totalPage
                            // 筛选之后总页数变少了，内容改变了一般都是从头开始看
                            var currentPage = 1
                            $pagination.twbsPagination('destroy')
                            // 重新设置
                            $pagination.twbsPagination(
                                $.extend({}, defaultOpts, {
                                    startPage: currentPage,
                                    totalPages: myTotalPages
                                })
                            )
                        }
                    }
                })
            }
            // 给筛选按钮加点击事件
            $("#btnSearch").click(function (e) {
                e.preventDefault();
                getData();
            })
            // 獲取分類數據
            $.ajax({
                url: "http://localhost:8000/admin/category_search",
                type: 'get',
                success: function (dataBack) {
                    console.log(dataBack);
                    // 調用核心方法
                    var html = template("tem1", dataBack);
                    // 用html會把全部分類覆蓋掉,所有要用添加子元素的方法
                    $("#selCategory").append(html);

                }
            })
        })
    </script>

</body>

</html>